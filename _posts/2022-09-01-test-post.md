---
title: "test TITLE"
date: 2022-09-01 12:00:00 -0000
permalink: test
author: aleks
tags: testing
---
# Invoke-SCOMDecrypt

## Introduction ##

This tool is designed to retrieve and decrypt RunAs credentials stored within Microsoft System Center Operations Manager (SCOM) databases.

## Pre-requisites ##

To run the tool you will require administrative privileges on the SCOM server. You will also need to ensure that you have read access to the following registry key:

    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center\2010\Common\MOMBins

You can check manually that you can see the database by gathering the connection details from the following keys:

    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center\2010\Common\Database\DatabaseServerName
    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center\2010\Common\Database\DatabaseName

## Usage ##

To run within the PowerShell console:

    powershell.exe -exec bypass
    . .\Invoke-SCOMDecrypt.ps1
    Invoke-SCOMDecrypt
    ...

## How the script works ##

Pre-requisite check to see if SCOM is installed
```ps1
	
	[string]$installDirectory = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\System Center\2010\Common\Setup").InstallDirectory
	if (Test-Path $installDirectory)
	{
		$Full_Path = [System.IO.Path]::GetFullPath($installDirectory);
		[string]$PATH1 = [System.IO.Path]::GetFullPath("$Full_Path`Microsoft.Mom.Sdk.SecureStorageManager.dll")
		[System.Reflection.Assembly]::LoadFile($PATH1) | Out-Null
		[string]$PATH2 = [System.IO.Path]::GetFullPath("$Full_Path`Microsoft.EnterpriseManagement.DataAccessLayer.dll")
		[System.Reflection.Assembly]::LoadFile($PATH2) | Out-Null
	}
	else
	{
		Write-Host "[Critical Error] Unable to find installation directory of SCOM" -ForegroundColor Yellow
		return
	}
```
Get SQL information from the registry

```ps1
	Try
	{
		$reg = Get-ItemProperty "HKLM:SOFTWARE\Microsoft\System Center\2010\Common\Database" -erroraction stop
		$server = $reg.DatabaseServerName
		$database = $reg.DatabaseName
	}
	Catch [System.Management.Automation.ItemNotFoundException]
	{
		Write-Host "[Critical Error] Unable to detect SQL server"
		return
	}
	
	Try
	{
		$reg = Get-ItemProperty "HKLM:SOFTWARE\Microsoft\System Center\2010\Common\MOMBins" -erroraction stop
		$key = $reg.Value1
	}
	Catch [System.Management.Automation.ItemNotFoundException]
	{
		Write-Host "[Critical Error] Unable to find key"
		return
	}
	```
